import { assertEqualString } from "@assert";
import { print } from "@io";
import { List, listFromArray } from "@list";
import { Map, mapCreate } from "@map";
import { lcmMany } from "@math";
import { String, stringFromNumber, stringToArray } from "@string";
import { getValue: getInput } from "./input.txt";

data Node = {
  left: String,
  right: String,
}

data Network = {
  instructions: List<boolean>,
  nodes: Map<String, Node>,
}

let parseInput = (input: String): Network -> {
  let instructions = [];
  let nodes = mapCreate();
  let lines = (input.trim()).toLines();
  let instructionsLine = lines.get(0);

  for char in listFromArray(stringToArray(instructionsLine)) {
    let instruction = false;

    if (char == 'L') {
      instruction = true;
    }

    instructions.push(instruction);
  }

  let nodesLines = lines.slice(2, lines.size());

  for nodeLine in nodesLines {
    let name = nodeLine.slice(0, 3);
    let left = nodeLine.slice(7, 10);
    let right = nodeLine.slice(12, 15);
    let node = Node.New({ left: left, right: right });

    nodes.set(name, node);
  }

  Network.New({ instructions: instructions, nodes: nodes })
}

let countSteps = (network: Network, start: String): u64 -> {
  let instructionIndex = 0;
  let current = start;
  let steps = 0;
  let loop = true;

  while loop {
    let instruction = (network.instructions).get(instructionIndex);
    let node = (network.nodes).get(current);
    let _ = match node {
      Some { value } -> {
        if instruction {
          current = value.left;
        } else {
          current = value.right;
        }
      };
      None -> print("Node not found");
    };

    instructionIndex = ((instructionIndex + 1) % (network.instructions).size());
    steps = (steps + 1);

    if (current.get(2) == 'Z') {
      loop = false;
    }
  }

  steps
}

let solvePart1 = (input: String): String -> {
  let network = parseInput(input);
  let result = countSteps(network, "AAA");

  stringFromNumber(result)
}

let solvePart2 = (input: String): String -> {
  let network = parseInput(input);
  let nodes = network.nodes;
  let allSteps = [];

  for item in nodes.entries() {
    if ((item.key).get(2) == 'A') {
      allSteps.push(countSteps(network, item.key));
    }
  }

  let result = lcmMany(allSteps);

  stringFromNumber(result)
}

let input = getInput();
let part1 = solvePart1(input);

assertEqualString(part1, "21883");

let part2 = solvePart2(input);

assertEqualString(part2, "12833235391111");
